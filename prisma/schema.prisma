// Direct Mail Platform - Simplified Prisma Schema
// Focused on: Direct Mail Management & Campaign Recommendations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE ENTITIES
// =============================================================================

model Account {
  id       String        @id @default(uuid())
  name     String
  type     AccountType
  status   AccountStatus @default(ACTIVE)
  settings Json          @default("{}")

  // Synthetic/demo account flag
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  markets         AccountMarket[]
  campaigns       Campaign[]
  segments        Segment[]
  offerStrategies OfferStrategy[]
  designTemplates DesignTemplate[]
  recommendations Recommendation[]

  @@index([type])
  @@index([status])
}

enum AccountType {
  WHOLESALER
  FLIPPER
  BUY_AND_HOLD
  TURNKEY_OPERATOR
  HEDGE_FUND
  ROOFER
  HOME_SERVICES
  PORTFOLIO_BUYER
}

enum AccountStatus {
  ACTIVE
  PAUSED
  SUSPENDED
  CLOSED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])

  isAiAgent Boolean @default(false)
  apiKey    String? @unique

  settings Json @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  createdCampaigns Campaign[] @relation("CampaignCreator")

  @@index([accountId])
  @@index([role])
}

enum UserRole {
  ADMIN
  MARKETING_MANAGER
  ANALYST
  ACQUISITIONS_MANAGER
  AE // Account Executive
  AI_AGENT
}

// =============================================================================
// MARKET & GEOGRAPHIC DATA
// =============================================================================

model Market {
  id     String  @id @default(uuid())
  name   String
  state  String
  county String
  city   String?

  // Market-level metrics
  medianPrice       Decimal? @db.Decimal(12, 2)
  avgDom            Int? // Average Days on Market
  priceAppreciation Decimal? @db.Decimal(5, 2) // YoY %
  buyerDensityScore Decimal? @db.Decimal(5, 4) // 0-1 scale
  spreadHistory     Json     @default("[]") // Historical spread data

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts   AccountMarket[]
  zipCodes   ZipCode[]
  properties Property[]
  dispoData  MarketDispoData[]

  @@unique([state, county])
  @@index([state])
}

model AccountMarket {
  id        String  @id @default(uuid())
  accountId String
  marketId  String
  account   Account @relation(fields: [accountId], references: [id])
  market    Market  @relation(fields: [marketId], references: [id])

  // Account-specific market settings
  avmBiasFactor Decimal  @default(1.0) @db.Decimal(5, 4)
  minSpread     Decimal? @db.Decimal(12, 2)
  maxArv        Decimal? @db.Decimal(12, 2)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, marketId])
}

model ZipCode {
  id       String @id @default(uuid())
  code     String @unique
  marketId String
  market   Market @relation(fields: [marketId], references: [id])

  // Zip-level metrics
  avgDom                Int?
  medianPrice           Decimal? @db.Decimal(12, 2)
  buyerDensityScore     Decimal? @db.Decimal(5, 4)
  investorActivityScore Decimal? @db.Decimal(5, 4)

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties Property[]

  @@index([marketId])
}

// =============================================================================
// PROPERTY & OWNER DATA
// =============================================================================

model Property {
  id String @id @default(uuid())

  // Address
  streetAddress String
  city          String
  state         String
  zipCodeId     String
  zipCode       ZipCode @relation(fields: [zipCodeId], references: [id])
  marketId      String
  market        Market  @relation(fields: [marketId], references: [id])

  // Property details
  propertyType PropertyType
  beds         Int?
  baths        Decimal?     @db.Decimal(3, 1)
  sqft         Int?
  lotSqft      Int?
  yearBuilt    Int?

  // Valuation
  avmValue      Decimal?   @db.Decimal(12, 2)
  arvValue      Decimal?   @db.Decimal(12, 2) // After Repair Value
  priceBand     PriceBand?
  lastSalePrice Decimal?   @db.Decimal(12, 2)
  lastSaleDate  DateTime?

  // Equity & Financial
  estimatedEquity   Decimal? @db.Decimal(12, 2)
  estimatedMortgage Decimal? @db.Decimal(12, 2)
  equityPercent     Decimal? @db.Decimal(5, 2)

  // Physical condition flags
  hasCodeViolation Boolean   @default(false)
  lastPermitDate   DateTime?
  conditionScore   Decimal?  @db.Decimal(3, 2) // 0-10 scale
  roofAge          Int?

  // Primary owner (shortcut for common case)
  primaryOwnerId String?
  primaryOwner   Owner?  @relation(fields: [primaryOwnerId], references: [id])

  // Computed scores
  dispoScore      Decimal? @db.Decimal(5, 4) // 0-1
  motivationScore Decimal? @db.Decimal(5, 4) // 0-1

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerships       PropertyOwnership[] // Full ownership history/details
  flags            PropertyFlag[] // Distress, motivation, and condition flags
  segmentMembers   SegmentMember[]
  mailPieces       MailPiece[]
  valuationHistory PropertyValuationHistory[]

  @@index([marketId])
  @@index([zipCodeId])
  @@index([priceBand])
  @@index([primaryOwnerId])
  @@index([dispoScore])
  @@index([motivationScore])
}

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  CONDO
  TOWNHOUSE
  MANUFACTURED
  LAND
  COMMERCIAL
}

enum PriceBand {
  BAND_0_100K // $0-100k
  BAND_100_200K // $100k-200k
  BAND_200_300K // $200k-300k
  BAND_300_500K // $300k-500k
  BAND_500K_PLUS // $500k+
}

// Track property valuation changes over time
model PropertyValuationHistory {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  // Valuation snapshot
  avmValue  Decimal?   @db.Decimal(12, 2)
  arvValue  Decimal?   @db.Decimal(12, 2)
  priceBand PriceBand?

  // Equity snapshot
  estimatedEquity   Decimal? @db.Decimal(12, 2)
  estimatedMortgage Decimal? @db.Decimal(12, 2)
  equityPercent     Decimal? @db.Decimal(5, 2)

  // Market context at time of valuation
  marketMedianPrice Decimal? @db.Decimal(12, 2)
  marketAvgDom      Int?

  // Source of valuation
  valuationSource ValuationSource
  confidence      Decimal?        @db.Decimal(5, 4) // 0-1

  // When this valuation was recorded
  valuationDate DateTime

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([propertyId])
  @@index([valuationDate])
  @@index([valuationSource])
}

enum ValuationSource {
  AVM_PROVIDER // Third-party AVM
  MLS_LISTING // From MLS listing
  RECENT_SALE // From comparable sales
  MANUAL_ESTIMATE // Manual entry
  APPRAISAL // Professional appraisal
  TAX_ASSESSMENT // County tax assessment
}

model Owner {
  id String @id @default(uuid())

  // Owner info
  firstName String
  lastName  String

  // Mailing address
  mailingStreet String?
  mailingCity   String?
  mailingState  String?
  mailingZip    String?

  // Contact
  phone String?
  email String? @unique

  // Owner type
  ownershipType OwnershipType
  isAbsentee    Boolean       @default(false)

  // Corporate owner flag
  isCorporate   Boolean @default(false)
  corporateName String?

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - One owner can own multiple properties
  properties         Property[] // Properties where this is primary owner
  propertyOwnerships PropertyOwnership[] // Full ownership details

  @@index([isAbsentee])
  @@index([ownershipType])
  @@index([email])
}

// Junction table for Property-Owner relationship with ownership details
model PropertyOwnership {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])
  ownerId    String
  owner      Owner    @relation(fields: [ownerId], references: [id])

  // Ownership details specific to this property
  ownershipLength      Int? // years owned
  ownershipPercent     Decimal? @db.Decimal(5, 2) // For partial ownership
  distanceFromProperty Decimal? @db.Decimal(10, 2) // km
  isPrimaryOwner       Boolean  @default(true)

  acquiredDate DateTime?
  soldDate     DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([propertyId, ownerId])
  @@index([propertyId])
  @@index([ownerId])
  @@index([isActive])
}

enum OwnershipType {
  OWNER_OCCUPIED
  ABSENTEE_IN_STATE
  ABSENTEE_OUT_OF_STATE
  CORPORATE
  TRUST
  ESTATE
}

// =============================================================================
// PROPERTY FLAGS (Unified System)
// =============================================================================

// Unified property flag model - supports distress, motivation, and condition flags
model PropertyFlag {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  // Flag categorization
  category FlagCategory

  // Type within category (only one should be set based on category)
  distressType        DistressType?
  motivationIndicator MotivationIndicator?
  conditionFlag       PropertyConditionFlag?

  severity FlagSeverity

  // Timing
  startDate  DateTime
  endDate    DateTime?
  daysActive Int?

  // Type-specific data
  metadata Json @default("{}")

  source String? // Data source

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([category])
  @@index([distressType])
  @@index([motivationIndicator])
  @@index([conditionFlag])
  @@index([severity])
  @@index([isActive])
  @@index([startDate])
}

enum FlagCategory {
  DISTRESS // Legal/financial distress situations
  MOTIVATION // Indicators of potential seller motivation
  CONDITION // Physical property condition issues
}

enum FlagSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Actual distress signals - legal/financial situations
enum DistressType {
  PRE_FORECLOSURE
  FORECLOSURE
  PROBATE
  INHERITANCE
  TAX_LIEN
  TAX_DELINQUENT
  DIVORCE
  CODE_VIOLATION
  EVICTION
  BANKRUPTCY
}

// Motivation indicators - characteristics that may indicate seller motivation
enum MotivationIndicator {
  VACANT // Property appears unoccupied
  ABSENTEE_OWNER // Owner lives elsewhere
  HIGH_EQUITY // Significant equity available
  TIRED_LANDLORD // Long-term rental owner showing signs of fatigue
  LONG_OWNERSHIP // Owned for many years (potential estate planning)
  FAILED_LISTING // Previously listed but didn't sell
  EXPIRED_LISTING // Listing expired
}

// Physical condition issues - property damage/maintenance
enum PropertyConditionFlag {
  ROOF_DAMAGE
  STORM_DAMAGE
  FOUNDATION_ISSUES
  FIRE_DAMAGE
  WATER_DAMAGE
  DEFERRED_MAINTENANCE
  MAJOR_REPAIRS_NEEDED
}

// =============================================================================
// DISPOSITION (DISPO) DATA
// =============================================================================

model MarketDispoData {
  id       String @id @default(uuid())
  marketId String
  market   Market @relation(fields: [marketId], references: [id])

  priceBand PriceBand

  // DOM metrics
  avgDom    Int
  medianDom Int
  domTrend  Decimal? @db.Decimal(5, 2) // % change

  // Transaction metrics
  listToSaleRatio Decimal  @db.Decimal(5, 4)
  avgSpread       Decimal  @db.Decimal(12, 2)
  medianSpread    Decimal  @db.Decimal(12, 2)
  spreadTrend     Decimal? @db.Decimal(5, 2)

  // Buyer metrics
  buyerDensity    Decimal @db.Decimal(5, 4)
  investorExitMix Json    @default("{}") // { flip: 0.4, rental: 0.3, wholesale: 0.3 }

  // Computed score
  dispoScore Decimal @db.Decimal(5, 4)

  // Time period
  periodStart DateTime
  periodEnd   DateTime

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketId, priceBand, periodStart])
  @@index([marketId])
  @@index([priceBand])
  @@index([dispoScore])
}

// =============================================================================
// SEGMENTS
// =============================================================================

model Segment {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  name        String
  description String?

  // Filter definition (JSON-based query)
  filters Json

  // Computed stats (refreshed periodically)
  memberCount      Int      @default(0)
  avgFreshnessDays Decimal? @db.Decimal(5, 1)
  avgDispoScore    Decimal? @db.Decimal(5, 4)
  avgMotivation    Decimal? @db.Decimal(5, 4)
  distressMix      Json     @default("{}")

  // Targeting rules
  maxMailsPerProperty Int     @default(6)
  minDaysBetweenMails Int     @default(21)
  excludeRecentDeals  Boolean @default(true)

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastRefreshedAt DateTime?

  // Relations
  members   SegmentMember[]
  campaigns CampaignSegment[]

  @@index([accountId])
  @@index([isActive])
}

model SegmentMember {
  id         String   @id @default(uuid())
  segmentId  String
  segment    Segment  @relation(fields: [segmentId], references: [id])
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  // Snapshot of key metrics at time of addition
  dispoScoreSnapshot    Decimal? @db.Decimal(5, 4)
  motivationSnapshot    Decimal? @db.Decimal(5, 4)
  distressFlagsSnapshot Json     @default("[]")

  addedAt   DateTime  @default(now())
  removedAt DateTime?

  @@unique([segmentId, propertyId])
  @@index([segmentId])
  @@index([propertyId])
}

// =============================================================================
// CAMPAIGNS & VARIANTS
// =============================================================================

model Campaign {
  id          String  @id @default(uuid())
  accountId   String
  account     Account @relation(fields: [accountId], references: [id])
  createdById String
  createdBy   User    @relation("CampaignCreator", fields: [createdById], references: [id])

  name        String
  description String?
  type        CampaignType
  goal        CampaignGoal

  status CampaignStatus @default(DRAFT)

  // Budget
  totalBudget Decimal? @db.Decimal(12, 2)
  spentBudget Decimal  @default(0) @db.Decimal(12, 2)

  // Timing
  startDate DateTime?
  endDate   DateTime?

  // Multi-touch flow settings
  isMultiTouch Boolean @default(true)
  touchCount   Int     @default(3)

  // A/B Testing (simplified from experiments module)
  isExperiment        Boolean  @default(false)
  experimentType      String?  // A_B_TEST, MULTI_ARM_BANDIT
  confidenceLevel     Decimal? @db.Decimal(3, 2) // e.g., 0.95

  // Performance summary (computed)
  totalMailed         Int      @default(0)
  totalDelivered      Int      @default(0)
  totalResponses      Int      @default(0)
  responseRate        Decimal? @db.Decimal(5, 4)
  costPerResponse     Decimal? @db.Decimal(10, 2)
  estimatedRevenue    Decimal? @db.Decimal(12, 2)
  roi                 Decimal? @db.Decimal(8, 4)

  isSynthetic Boolean @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  launchedAt  DateTime?
  completedAt DateTime?

  // Relations
  segments CampaignSegment[]
  variants Variant[]
  batches  Batch[]
  steps    CampaignStep[]

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([isExperiment])
  @@index([createdAt])
}

enum CampaignType {
  WHOLESALER
  FLIPPER
  BUY_AND_HOLD
  ROOFER
  HOME_SERVICES
  MIXED
}

enum CampaignGoal {
  CONTRACTS
  APPOINTMENTS
  LEADS
  BRAND_AWARENESS
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model CampaignSegment {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  segmentId  String
  segment    Segment  @relation(fields: [segmentId], references: [id])

  // Segment-specific budget allocation
  budgetPercent Decimal @default(100) @db.Decimal(5, 2)

  createdAt DateTime @default(now())

  @@unique([campaignId, segmentId])
}

model CampaignStep {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  stepNumber Int
  name       String?

  // Timing
  daysSincePrevious Int  @default(21)
  daysSinceTrigger  Int? // For trigger-based steps

  // Default design for this step
  designTemplateId String?
  designTemplate   DesignTemplate? @relation(fields: [designTemplateId], references: [id])

  // Default offer strategy
  offerStrategyId String?
  offerStrategy   OfferStrategy? @relation(fields: [offerStrategyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants Variant[]

  @@unique([campaignId, stepNumber])
  @@index([campaignId])
}

model Variant {
  id         String        @id @default(uuid())
  campaignId String
  campaign   Campaign      @relation(fields: [campaignId], references: [id])
  stepId     String?
  step       CampaignStep? @relation(fields: [stepId], references: [id])

  name        String
  description String?

  // Variant configuration
  designVersionId String?
  designVersion   DesignVersion? @relation(fields: [designVersionId], references: [id])
  offerStrategyId String?
  offerStrategy   OfferStrategy? @relation(fields: [offerStrategyId], references: [id])

  // Traffic allocation
  allocationPercent Decimal @default(50) @db.Decimal(5, 2)

  // Performance metrics
  piecesMailed    Int     @default(0)
  piecesDelivered Int     @default(0)
  responses       Int     @default(0)

  // Computed rates
  responseRate   Decimal? @db.Decimal(5, 4)
  costPerResponse Decimal? @db.Decimal(10, 2)

  // A/B Test results
  isControl          Boolean  @default(false)
  isWinner           Boolean?
  pValue             Decimal? @db.Decimal(8, 6)
  liftVsControl      Decimal? @db.Decimal(8, 4)
  confidenceInterval Json? // { lower: 0.01, upper: 0.05 }

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  batches    BatchVariant[]
  mailPieces MailPiece[]

  @@index([campaignId])
  @@index([stepId])
  @@index([isWinner])
}

model Batch {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  batchNumber Int
  name        String?

  status BatchStatus @default(PENDING)

  // Timing
  scheduledDate DateTime?
  sentDate      DateTime?

  // Volume
  targetQuantity Int
  actualQuantity Int @default(0)

  // Performance (aggregated from variants)
  totalDelivered Int @default(0)
  totalResponses Int @default(0)

  // Print vendor info (Lob integration)
  printJobId  String?
  printStatus String?

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants   BatchVariant[]
  mailPieces MailPiece[]

  @@unique([campaignId, batchNumber])
  @@index([campaignId])
  @@index([status])
}

enum BatchStatus {
  PENDING
  SCHEDULED
  PRINTING
  MAILED
  DELIVERED
  COMPLETED
}

model BatchVariant {
  id        String  @id @default(uuid())
  batchId   String
  batch     Batch   @relation(fields: [batchId], references: [id])
  variantId String
  variant   Variant @relation(fields: [variantId], references: [id])

  quantity Int

  createdAt DateTime @default(now())

  @@unique([batchId, variantId])
}

// =============================================================================
// DESIGN & CREATIVE
// =============================================================================

model DesignTemplate {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  name        String
  format      MailFormat
  description String?

  // Template settings
  supportsOffer  Boolean @default(true)
  offerPlacement String? // e.g., "check_amount", "body_text"

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  versions      DesignVersion[]
  campaignSteps CampaignStep[]

  @@index([accountId])
  @@index([format])
}

enum MailFormat {
  CHECK_LETTER
  GENERIC_LETTER
  STANDARD_POSTCARD
  OVERSIZED_POSTCARD
  HANDWRITTEN_POSTCARD
  SNAP_PACK
  SORRY_WE_MISSED_YOU
  YELLOW_LETTER
}

model DesignVersion {
  id         String         @id @default(uuid())
  templateId String
  template   DesignTemplate @relation(fields: [templateId], references: [id])

  versionNumber Int
  name          String?

  // Creative content
  headline     String?
  bodyContent  String?
  callToAction String?
  imageUrl     String?

  // A/B test elements
  testElements Json @default("[]") // What's different in this version

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants   Variant[]
  mailPieces MailPiece[]

  @@unique([templateId, versionNumber])
  @@index([templateId])
}

// =============================================================================
// OFFER STRATEGIES
// =============================================================================

model OfferStrategy {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  name        String
  description String?

  // Base offer percentages by price band
  baseOffers Json // { "BAND_0_100K": 0.65, "BAND_100_200K": 0.70, ... }

  // Adjustments
  distressAdjustments Json @default("{}") // { "PRE_FORECLOSURE": -0.05, "PROBATE": -0.03 }
  dispoAdjustments    Json @default("{}") // { "lowDispoScore": -0.05, "highDom": -0.03 }

  // Constraints
  minOfferPercent Decimal @default(0.50) @db.Decimal(5, 4)
  maxOfferPercent Decimal @default(0.90) @db.Decimal(5, 4)

  // Range vs fixed
  useOfferRange Boolean  @default(false)
  rangeWidth    Decimal? @db.Decimal(5, 4) // e.g., 0.05 = Â±5%

  isActive    Boolean @default(true)
  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaignSteps CampaignStep[]
  variants      Variant[]
  mailPieces    MailPiece[]

  @@index([accountId])
}

// =============================================================================
// MAIL TRACKING
// =============================================================================

model MailPiece {
  id String @id @default(uuid())

  batchId    String
  batch      Batch    @relation(fields: [batchId], references: [id])
  variantId  String
  variant    Variant  @relation(fields: [variantId], references: [id])
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  // Design used
  designVersionId String?
  designVersion   DesignVersion? @relation(fields: [designVersionId], references: [id])

  // Offer details
  offerStrategyId String?
  offerStrategy   OfferStrategy? @relation(fields: [offerStrategyId], references: [id])
  offerAmount     Decimal?       @db.Decimal(12, 2)
  offerPercent    Decimal?       @db.Decimal(5, 4)

  // Tracking
  trackingNumber String?
  lobId          String? // Lob API mail piece ID

  // Status
  status MailStatus @default(CREATED)

  // Cost
  printCost   Decimal? @db.Decimal(8, 4)
  postageCost Decimal? @db.Decimal(8, 4)
  totalCost   Decimal? @db.Decimal(8, 4)

  // Response tracking
  hasResponded   Boolean   @default(false)
  respondedAt    DateTime?
  responseType   String?   // CALL, WEBSITE, QR_CODE, etc.

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events MailEvent[]

  @@index([batchId])
  @@index([variantId])
  @@index([propertyId])
  @@index([status])
  @@index([createdAt])
  @@index([hasResponded])
}

enum MailStatus {
  CREATED
  QUEUED
  PRINTING
  MAILED
  IN_TRANSIT
  DELIVERED
  RETURNED
  UNDELIVERABLE
}

model MailEvent {
  id          String    @id @default(uuid())
  mailPieceId String
  mailPiece   MailPiece @relation(fields: [mailPieceId], references: [id])

  eventType MailEventType
  timestamp DateTime      @default(now())

  // Location (if available from USPS/Lob)
  location String?

  // Additional data
  metadata Json @default("{}")

  isSynthetic Boolean @default(false)

  @@index([mailPieceId])
  @@index([eventType])
  @@index([timestamp])
}

enum MailEventType {
  CREATED
  SENT_TO_PRINTER
  PRINTED
  MAILED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FORWARDED
  RETURNED_TO_SENDER
  RETURN_UNKNOWN
  RETURN_VACANT
  RETURN_REFUSED
}

// =============================================================================
// RECOMMENDATIONS (AI-Powered Campaign Suggestions)
// =============================================================================

model Recommendation {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  // Recommendation type
  type RecommendationType

  // What is being recommended
  category RecommendationCategory

  // Recommendation details
  title       String
  description String
  reasoning   String // Why this is recommended

  // Confidence and priority
  confidence Decimal @db.Decimal(5, 4) // 0-1
  priority   RecommendationPriority

  // Specific recommendation data (varies by type)
  data Json @default("{}")
  // Examples:
  // WHO: { segmentFilters: {...}, estimatedSize: 5000, avgMotivation: 0.75 }
  // WHAT: { templateId: "...", offerStrategy: {...}, expectedLift: 0.15 }
  // HOW: { touchCount: 3, timing: [0, 21, 42], budget: 10000 }

  // Expected impact
  expectedImpact      Json @default("{}") // { responseRate: 0.025, estimatedROI: 2.5 }
  estimatedBudget     Decimal? @db.Decimal(12, 2)
  estimatedResponses  Int?
  estimatedRevenue    Decimal? @db.Decimal(12, 2)

  // Status
  status RecommendationStatus @default(PENDING)

  // User action
  actionTaken   String?   // APPLIED, DISMISSED, MODIFIED
  actionTakenAt DateTime?
  actionNotes   String?

  // If applied, link to resulting campaign
  appliedCampaignId String?

  isSynthetic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime? // Recommendations can expire

  // Relations
  feedback RecommendationFeedback[]

  @@index([accountId])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

enum RecommendationType {
  PROACTIVE // System-generated based on data analysis
  ON_DEMAND // User-requested recommendation
  OPTIMIZATION // Improvement to existing campaign
}

enum RecommendationCategory {
  WHO // Target audience recommendation
  WHAT // Creative and offer recommendation
  HOW // Campaign structure recommendation
  TIMING // When to send recommendation
  BUDGET // Budget allocation recommendation
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RecommendationStatus {
  PENDING // New recommendation
  VIEWED // User has seen it
  APPLIED // User applied recommendation
  DISMISSED // User dismissed it
  EXPIRED // Recommendation no longer valid
}

// Feedback on recommendations to improve the AI
model RecommendationFeedback {
  id               String         @id @default(uuid())
  recommendationId String
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id])

  // Feedback type
  feedbackType FeedbackType

  // Rating (if applicable)
  rating Int? // 1-5

  // Actual results (if recommendation was applied)
  actualResponseRate Decimal? @db.Decimal(5, 4)
  actualROI          Decimal? @db.Decimal(8, 4)
  actualRevenue      Decimal? @db.Decimal(12, 2)

  // User comments
  comments String?

  createdAt DateTime @default(now())

  @@index([recommendationId])
  @@index([feedbackType])
}

enum FeedbackType {
  HELPFUL
  NOT_HELPFUL
  INACCURATE
  APPLIED_SUCCESS
  APPLIED_FAILURE
}
